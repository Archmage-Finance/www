<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge,chrome=1"><link rel=stylesheet href=https://unpkg.com/bulmaswatch/darkly/bulmaswatch.min.css media=screen><link rel=stylesheet href=https://www.archmage.fi/style.main.min.929322bf65f0ab8a680e9ab7dbf3252f03361d38225e513fd5407665ada5eb53.css media=screen><meta property="og:title" content="Verifying Pixel Cats"><meta property="og:description" content="Now that minting has started on Pixel Cats, owners might want to know how to verify that their cat is contained within the preset provenance hash. There are two ways you could do this - on-chain or off-chain.
On-Chain Head over to the contract on FTMScan and find your token id by entering your address and 0 as the index on the tokenOfOwnerByIndex function. Press the query button and it will return the token id that you own."><meta property="og:type" content="article"><meta property="og:url" content="https://www.archmage.fi/posts/verifying-pixel-cats/"><meta property="article:published_time" content="2022-04-18T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-18T00:00:00+00:00"><meta property="og:site_name" content="Archmage"><title>Verifying Pixel Cats &ndash; Archmage</title><link rel=icon type=image/png href=https://www.archmage.fi//images/favicon.png></head><body><div class=wrapper><nav id=navbar class="navbar offset-top is-fixed-top" role=navigation aria-label="main navigation"><div class=container><div class=navbar-brand><a class=navbar-item href=https://www.archmage.fi/><img src=https://www.archmage.fi//images/logo.png></a>
<a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=main-navbar><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div id=main-navbar class=navbar-menu><div class=navbar-start><a class=navbar-item href=https://www.archmage.fi/>Archmage</a>
<a class=navbar-item href=https://www.archmage.fi/posts>Developer blog</a></div></div><div class=navbar-end><a class="navbar-item button is-outlined is-primary" href=https://app.archmage.fi>Launch App</a></div></div></nav><div class=main><div class=grow-content><div class=container><div class=content><section class=post-content><h1>Verifying Pixel Cats</h1><div class=post-date><img class="icon date" src=https://www.archmage.fi//images/calendar-month.png>Monday, 18 April 2022</div><p>Now that minting has started on <a href=https://www.pixel-cats.art>Pixel Cats</a>, owners might want to know how to verify that their cat is contained within the preset provenance hash. There are two ways you could do this - on-chain or off-chain.</p><h2 id=on-chain>On-Chain</h2><p>Head over to the <a href=https://ftmscan.com/address/0x2bB70b039b6516AC754eA1de7A0F75C92069d74F#readContract>contract</a> on FTMScan and find your token id by entering your address and 0 as the index on the <code>tokenOfOwnerByIndex</code> function. Press the query button and it will return the token id that you own.</p><p><img src=get-tokenid.png alt="Find your token id" style=width:200px></p><p>Next you can get the merkle tree proofs needed to match up by putting the token id that you own into the <code>tokenProofUri</code> function.</p><p><img src=get-proof.png alt="Find your proof" style=width:200px></p><p>The returned string is an IPFS url along the lines of <code>ipfs://QmZoCZU7QiY9nbwkwB1kzDjkmxxSJgXiUXw7NCTuv1yKQc/proof.&lt;TOKEN_ID>.json</code>. In order to view this url in the browser, simply copy and paste the string into your nav bar and replace <code>ipfs://</code> with <code>https://www.pixel-cats.art/ipfs/</code>. The full url should be <code>https://www.pixel-cats.art/ipfs/QmZoCZU7QiY9nbwkwB1kzDjkmxxSJgXiUXw7NCTuv1yKQc/proof.&lt;TOKEN_ID>.json</code> where <code>&lt;TOKEN_ID></code> is the token id that you own.</p><p>The resulting information is the proof needed to verify that your token matches the provenance on-chain.</p><p>Enter the information into the <code>proveTokenMetadata</code> function on FTMScan as follows:</p><p><img src=prove-token.png alt="Prove the token id" style=width:200px></p><ol><li>Put your token id into the <code>_tokenid</code> field.</li><li>Put the metadata string from the proof json into the <code>_metadata</code> field.</li><li>Put the array of bytes from the proof json into the <code>_merkleProof</code> field (e.g. for token id 674 the proof is <code>[0x33a92d51e5c60beb90c76d07b6a01dc4979a4efc4b77d9ca6938c4410cf4f104, 0x83e9f2a18b4a1eaaea047b94337e3ef081a2b6078f59ed2ffc475aa29234de09, 0x4ce42a0b2dd408e4a7c57ff102fbfecf0c63ed4cae45a8df101ace6d0b8349fb, 0x47937d99586b2ae6839f03d76d830076361aa65788f8946639d0e02024d876e0, 0x90ac27f6e9767c9079c3ddb3f8727f9668792a0f6aa8f29bf40be10a67dce0c8, 0x82b061ea7c8a3101acf1e4e73fb91ba94df9812bc78325665e7d26586458e1a7, 0xaaafa30294d1ceed59febef61d88ac58d42dca0ae8acca248fbef48beb900d9c, 0x81f60cc2e94944f6170b379fcf601dac66e43c7e4135705990317cd431905fab, 0xfc9453ff934ce7281eb5455a7c4dbaa8003d8ef78008a48313387ddec66b13f9, 0xd8681c2f47ac67bc52d3b776f348fb3a2a72b646c2c7ed787c86f291aacca34c]</code>).</li></ol><p>Note that you should remove the double quotes when putting in the data into the fields. The resulting value will be true if it matches the provenance hash, and false if it has changed. If false that means that the token data has been changed and cannot be trusted since it no longer matches the original data.</p><h2 id=off-chain>Off-chain</h2><p>So you can verify the data on-chain, but how do you know that the proof itself and the hashed metadata is correct? We can do that quite simply by running a small script your machine.</p><h3 id=find-the-hash-of-the-metadata>Find the hash of the metadata</h3><p>Firstly grab your metadata from the above contract by using the <code>tokenURI</code> read function and replacing the ipfs url as shown above. Right click on the resulting json and <code>Save Page As...</code> to your local file system. We will use this file to verify that the metadata matches the value in the proof.</p><p>We&rsquo;re going to use NodeJS to verify the metadata. There are many tutorials out there to get started with Node but the basic script to run is as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>utils</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;ethers&#39;</span>

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>json</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>`FILE_LOCATION_OF_METADATA_JSON`</span>) <span style=color:#75715e>// this is the metadata json that we just downloaded
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hash</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>solidityKeccak256</span>([<span style=color:#e6db74>&#39;string&#39;</span>], [<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>json</span>)])
<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>hash</span>)
</code></pre></div><p>The resulting output will be the metadata string in the proof object that we looked at earlier.</p><h3 id=generate-the-provenance-hash>Generate the provenance hash</h3><p>Pixel Cats uses a merkle tree to generate the provenance, which means that each part of the proof is needed to generate the next level in the tree. A merkle tree is an efficient storage method as you do not need the information of the entire tree to verify a single part. As an example in the following image assume you have token id 6. In order to get to the merkle root (i.e. the provenance hash), you need you to hash the metadata of token 5 and 6 together to generate H(56), then use that with H(78) to generated H(56,78), etc. The proof included in the proof json we looked at earlier is each of the blue nodes that we need to generate the provenance hash.</p><p><img src=merkle-tree.png alt="Merkle tree example" style=width:500px></p><p>So let&rsquo;s generate the provenance from our merkle proofs:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>utils</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;ethers&#39;</span>

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>proof</span> <span style=color:#f92672>=</span> [] <span style=color:#75715e>// put your proofs in here (in quotes)
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>metadataHash</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#75715e>// this is the hash we just generated in the previous example
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tokenId</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> <span style=color:#75715e>// change to your token id that matches the metadata
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>hash</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>solidityKeccak256</span>([<span style=color:#e6db74>&#39;uint&#39;</span>, <span style=color:#e6db74>&#39;string&#39;</span>], [parseInt(<span style=color:#a6e22e>tokenId</span>, <span style=color:#ae81ff>10</span>), <span style=color:#a6e22e>metadataHash</span>])
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>tokenId</span>, <span style=color:#ae81ff>10</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>

<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>p</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>proof</span>) {
    <span style=color:#66d9ef>if</span> ((<span style=color:#a6e22e>path</span> <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x01</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
        <span style=color:#a6e22e>hash</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>solidityKeccak256</span>([<span style=color:#e6db74>&#39;bytes32&#39;</span>, <span style=color:#e6db74>&#39;bytes32&#39;</span>], [<span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>hash</span>])
    } <span style=color:#66d9ef>else</span> {
        <span style=color:#a6e22e>hash</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>solidityKeccak256</span>([<span style=color:#e6db74>&#39;bytes32&#39;</span>, <span style=color:#e6db74>&#39;bytes32&#39;</span>], [<span style=color:#a6e22e>hash</span>, <span style=color:#a6e22e>p</span>])
    }
    <span style=color:#a6e22e>path</span> <span style=color:#f92672>/=</span> <span style=color:#ae81ff>2</span>
}

<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>hash</span>)
</code></pre></div><p>The output should match the provenance listed on the contract. But what about verifying that the proofs themselves are correct? Then you&rsquo;d need to do the same thing as we did above for <strong>every</strong> token id and create the entire merkle tree. That&rsquo;s a bit out of scope for this exercise and this is not the only way to verifiably produce a provenance hash. BAYC used a more simple method whereby you could concatenate the hashes of all tokens and generate a hash from the string, and you can come up with your own method if you want.</p><h2 id=caveats>Caveats</h2><p>The keen eyed reader might notice that the IPFS urls are public and browseable. The rarity information is also stored in the same directory as the normal metadata, making it possible for someone to scrape all the metadata and find the highest value/rarest tokens. This is done intentionally for a number of reasons:</p><ol><li>Show people the tradeoffs they might need to make between simplicity and fair distribution, and how rarity information can be used to attack less hardened projects.</li><li>Show how the project can be improved by having a <code>setBaseURI</code> function and setting it to a new IPFS directory containing the rarity information once minting is complete.</li><li>For this project it&rsquo;s not as necessary to completely hide the rarity information as currently there&rsquo;s no intrinsic value yet to the token.</li></ol><p>Any questions or suggestions then let us know on <a href=https://twitter.com/archmagefi_>Twitter</a>!</p></section></div></div></div><footer class=footer><div class=container><div class=content><div class=columns><div class="column copyright"><div><img class=icon src=https://www.archmage.fi//images/logo.png>Archmage</div><div>© Archmage 2022</div><div>All Rights Reserved</div></div><div class=column><div class=heading>SITE</div><div class=item><a href=https://www.archmage.fi/posts>Developer Blog</a></div><div class=item><a href=https://cap-dashboard.archmage.fi/ target=_blank>Cap.finance Dashboard</a></div><div class=item><a href=https://www.pixel-cats.art/ target=_blank>Pixel Cats</a></div></div><div class=column><div class=heading>SOCIAL</div><div class=item><a href=https://twitter.com/archmagefi_ target=_blank><img class=icon src=https://www.archmage.fi//images/twitter.png>Twitter</a></div><div class=item><a href=https://github.com/Archmage-Finance target=_blank><img class=icon src=https://www.archmage.fi//images/github.png>Github</a></div></div></div></div></div></footer></div></div><script src=https://www.archmage.fi//js/main.js></script></body></html>